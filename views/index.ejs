<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GamePlan</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .admin-alert {
      background: rgba(255, 255, 0, 0.2);
      border: 2px solid #ffff00;
      color: #ffff00;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      text-align: center;
      animation: pulse 2s infinite;
    }
    .admin-alert a {
      color: #ffff00;
      text-decoration: underline;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="scanlines"></div>
  <% if (isDevelopmentAutoLogin) { %>
    <div class="dev-banner">
      üîß DEVELOPMENT MODE - Auto-logged in as Admin
    </div>
  <% } %>
  <header>
    <h1>GamePlan</h1>
  <nav>
      <% if (typeof user !== 'undefined') { %>
        <a href="/profile">Profile</a>
        <a href="/logout">Logout</a>
        <p>Welcome, <%= user.gameNickname ? user.gameNickname : user.name %></p>
      <% } else { %>
        <a href="/login">Login</a>
        <a href="/register">Register</a>
      <% } %>
    </nav>
  </header>
  <main>
    <h2>Events</h2>
    <% if (typeof user !== 'undefined') { %>
      <button class="event-button" onclick="window.location.href='/event/new'">Create New Event</button>
      <% if (user.isAdmin) { %>
        <!-- Admin button -->
        <button class="admin-button" onclick="window.location.href='/admin'">Admin</button>
        <!-- Admin alert for pending users -->
        <div id="admin-alert" class="admin-alert" style="display: none;">
          <span id="pending-count">0</span> user(s) pending approval
          <a href="/admin/users" style="margin-left: 10px;">Review ‚Üí</a>
        </div>
      <% } %>
    <% } %>

    <div class="events-grid">
      <% events.forEach(event => { %>
        <div class="event-card" onclick="window.location.href='/event/<%= event._id %>'">
          <div class="event-image-container">
            <% if (event.game && event.game.steamData && event.game.steamData.header_image) { %>
              <img src="<%= event.game.steamData.header_image %>" alt="<%= event.game.name %>" class="game-image">
            <% } else { %>
              <div class="game-image-placeholder">
                <span class="game-icon">üéÆ</span>
              </div>
            <% } %>
            <% if (event.requiredExtensions && event.requiredExtensions.length > 0) { %>
              <div class="extensions-badge">
                <span class="extensions-icon">üîß</span>
                <span class="extensions-text">MODS REQ</span>
                <span class="extensions-count"><%= event.requiredExtensions.length %></span>
              </div>
            <% } %>
          </div>
          
          <div class="event-details">
            <h3 class="event-title"><%= event.name %></h3>
            <div class="game-name">
              <span class="game-label">GAME:</span>
              <span class="game-value"><%= event.game ? event.game.name : 'Unknown Game' %></span>
            </div>
            
            <div class="player-info">
              <div class="player-count">
                <span class="player-label">PLAYERS:</span>
                <div class="player-slots">
                  <% for (let i = 0; i < event.playerLimit; i++) { %>
                    <span class="player-slot <%= i < event.players.length ? 'filled' : 'empty' %>">‚óè</span>
                  <% } %>
                  <span class="player-numbers">(<%= event.players.length %>/<%= event.playerLimit %>)</span>
                </div>
              </div>
            </div>
            
            <div class="event-meta">
              <div class="event-date">
                <%= new Date(event.date).toLocaleDateString('en-GB', { 
                  weekday: 'short', 
                  day: '2-digit', 
                  month: 'short',
                  hour: '2-digit',
                  minute: '2-digit'
                }) %>
              </div>
              <% if (event.platforms && event.platforms.length > 0) { %>
                <div class="platforms">
                  <% event.platforms.forEach(platform => { %>
                    <span class="platform-tag"><%= platform %></span>
                  <% }) %>
                </div>
              <% } %>
            </div>
            
            <% if (event.description) { %>
              <div class="event-description">
                <%= event.description.length > 100 ? event.description.substring(0, 100) + '...' : event.description %>
              </div>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>
  </main>

  <% if (typeof user !== 'undefined' && user.isAdmin) { %>
  <script>
    // Fetch pending user count for admin alert
    async function fetchPendingUserCount() {
      try {
        const response = await fetch('/api/admin/pending-count');
        const data = await response.json();
        const alertDiv = document.getElementById('admin-alert');
        const countSpan = document.getElementById('pending-count');
        
        if (data.count > 0) {
          countSpan.textContent = data.count;
          alertDiv.style.display = 'block';
        } else {
          alertDiv.style.display = 'none';
        }
      } catch (error) {
        console.error('Error fetching pending user count:', error);
      }
    }

    // Fetch count on page load
    document.addEventListener('DOMContentLoaded', fetchPendingUserCount);
    
    // Refresh count every 30 seconds
    setInterval(fetchPendingUserCount, 30000);
  </script>
  <% } %>
</body>
</html>
