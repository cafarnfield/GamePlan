<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Events Management - GamePlan</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    .events-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    .events-table th,
    .events-table td {
      border: 1px solid #00ff00;
      padding: 8px;
      text-align: left;
    }
    .events-table th {
      background-color: #001100;
      color: #00ff00;
    }
    .events-table tr:nth-child(even) {
      background-color: #000500;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    .btn-small {
      padding: 5px 10px;
      font-size: 10px;
      border: 1px solid #00ff00;
      background-color: #000;
      color: #00ff00;
      cursor: pointer;
      text-decoration: none;
    }
    .btn-small:hover {
      background-color: #00ff00;
      color: #000;
    }
    .btn-danger {
      border-color: #ff0000;
      color: #ff0000;
    }
    .btn-danger:hover {
      background-color: #ff0000;
      color: #000;
    }
    .filter-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #00ff00;
      background-color: #001100;
    }
    .filter-row {
      display: flex;
      gap: 15px;
      align-items: center;
      margin-bottom: 10px;
    }
    .filter-row label {
      min-width: 100px;
    }
    .filter-row select,
    .filter-row input {
      padding: 5px;
      background-color: #000;
      color: #00ff00;
      border: 1px solid #00ff00;
    }
  </style>
</head>
<body>
  <div class="scanlines"></div>
  <header>
    <h1>GamePlan Admin</h1>
    <nav>
      <a href="/">Home</a>
      <a href="/admin">Admin Panel</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/events">Events</a>
      <a href="/admin/dashboard">Dashboard</a>
      <% if (!isDevelopmentAutoLogin) { %>
        <a href="/logout">Logout</a>
      <% } %>
    </nav>
  </header>
  <main>
    <h2>Events Management</h2>
    
    <div class="filter-section">
      <h3>Filter Events</h3>
      <form method="GET" action="/admin/events">
        <div class="filter-row">
          <label for="status">Status:</label>
          <select name="status" id="status">
            <option value="">All Events</option>
            <option value="upcoming" <%= filter === 'upcoming' ? 'selected' : '' %>>Upcoming</option>
            <option value="past" <%= filter === 'past' ? 'selected' : '' %>>Past</option>
          </select>
          
          <label for="game">Game:</label>
          <select name="game" id="game">
            <option value="">All Games</option>
            <% games.forEach(game => { %>
              <option value="<%= game._id %>" <%= selectedGame === game._id.toString() ? 'selected' : '' %>><%= game.name %></option>
            <% }) %>
          </select>
          
          <button type="submit" class="btn-small">Filter</button>
        </div>
      </form>
    </div>

    <div class="stats">
      <p>Total Events: <%= events.length %></p>
      <p>Upcoming Events: <%= events.filter(e => new Date(e.date) >= new Date()).length %></p>
      <p>Past Events: <%= events.filter(e => new Date(e.date) < new Date()).length %></p>
    </div>

    <table class="events-table">
      <thead>
        <tr>
          <th>Event Name</th>
          <th>Game</th>
          <th>Creator</th>
          <th>Date</th>
          <th>Players</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (events.length === 0) { %>
          <tr>
            <td colspan="7" style="text-align: center;">No events found</td>
          </tr>
        <% } else { %>
          <% events.forEach(event => { %>
            <tr>
              <td><%= event.name %></td>
              <td><%= event.game ? event.game.name : 'Unknown Game' %></td>
              <td>
                <% if (event.createdBy) { %>
                  <%= event.createdBy.gameNickname || event.createdBy.name %>
                <% } else if (event.players && event.players.length > 0) { %>
                  <%= event.players[0].gameNickname || event.players[0].name %> (Legacy)
                <% } else { %>
                  Unknown
                <% } %>
              </td>
              <td><%= new Date(event.date).toLocaleDateString() %> <%= new Date(event.date).toLocaleTimeString() %></td>
              <td><%= event.players ? event.players.length : 0 %>/<%= event.playerLimit %></td>
              <td>
                <% if (new Date(event.date) >= new Date()) { %>
                  <span style="color: #00ff00;">Upcoming</span>
                <% } else { %>
                  <span style="color: #ffff00;">Past</span>
                <% } %>
              </td>
              <td>
                <div class="action-buttons">
                  <a href="/event/<%= event._id %>" class="btn-small">View</a>
                  <a href="/event/<%= event._id %>/edit" class="btn-small">Edit</a>
                  <form action="/admin/event/<%= event._id %>/delete" method="POST" style="display: inline;" 
                        onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone.');">
                    <button type="submit" class="btn-small btn-danger">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>

    <% if (events.length > 0) { %>
      <div style="margin-top: 20px;">
        <h3>Bulk Actions</h3>
        <form action="/admin/events/bulk-delete" method="POST" 
              onsubmit="return confirm('Are you sure you want to delete all selected events? This action cannot be undone.');">
          <div style="margin-bottom: 10px;">
            <label>
              <input type="checkbox" id="selectAll"> Select All
            </label>
          </div>
          <div id="selectedEvents">
            <% events.forEach(event => { %>
              <label style="display: block; margin: 5px 0;">
                <input type="checkbox" name="eventIds" value="<%= event._id %>" class="event-checkbox">
                <%= event.name %> - <%= event.game ? event.game.name : 'Unknown Game' %>
              </label>
            <% }) %>
          </div>
          <div style="margin-top: 15px;">
            <label for="notes">Reason for deletion:</label><br>
            <textarea name="notes" id="notes" rows="3" cols="50" 
                      style="background-color: #000; color: #00ff00; border: 1px solid #00ff00; padding: 5px;"></textarea>
          </div>
          <button type="submit" class="btn-small btn-danger" style="margin-top: 10px;">Delete Selected Events</button>
        </form>
      </div>
    <% } %>
  </main>

  <script>
    // Select all functionality
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.event-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });

    // Update select all when individual checkboxes change
    document.querySelectorAll('.event-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const allCheckboxes = document.querySelectorAll('.event-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.event-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        if (checkedCheckboxes.length === allCheckboxes.length) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes.length === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      });
    });
  </script>
</body>
</html>
